<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="Bookmark" href="/favicon.ico" >
<link rel="Shortcut Icon" href="/favicon.ico" />
<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5shiv.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="static/h-ui/css/H-ui.min.css" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/skin/default/skin.css" id="skin" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/style.css" />
<link rel="stylesheet" href="lib/zTree/v3/css/zTreeStyle/zTreeStyle.css" type="text/css">

<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script> 
<title>新增账号</title>
</head>
<body>
	<article class="page-container">
		<form action="" method="post" class="form form-horizontal" id="apk-form">
	
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="required-label c-red">*</span>应用名：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<input type="text" class="input-text" value="" placeholder="请输入应用名" id="app-name" name="appName" >
				</div>
			</div>
			<div class="row cl" >
				<label class="form-label col-xs-4 col-sm-3"><span class="required-label c-red">*</span>VersionName：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<input type="text" class="input-text" value="" placeholder="VersionName" id="version-name" name="versionName" >
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="required-label c-red">*</span>VersionCode：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<input type="text" class="input-text" value="" placeholder="VersionCode" id="version-code" name="versionCode" >
				</div>
			</div>

			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="required-label c-red">*</span>更新说明：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<textarea id="update-instructions" name="updateInstructions"  maxlength="140" class="textarea"  placeholder="请输入更新说明" style="height:65px"></textarea>
				</div>
			</div>
			<div class="row cl ">
				<label class="form-label col-xs-4 col-sm-3"><span class="required-label c-red">*</span>是否强制升级：</label>
				<div class="formControls col-xs-8 col-sm-9 skin-minimal">
					<div class="radio-box">
						<input type="radio" class="radio " name="mandatoryUpdate" id="mandatory-update-1" value="1"><label for="mandatory-update-yes">是</label>
					</div>
					<div class="radio-box">
						<input type="radio" class="radio" name="mandatoryUpdate" id="mandatory-update-2" value="0" ><label for="mandatory-update-no">否</label>
					</div>
				</div>
			</div>

			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red" id="file-red-start" >*</span>安装包文件：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span class="btn-upload form-group" style="width:100%">
					  <input class="input-text upload-url radius" type="text" id="file-name" readonly  style="width:82%" ><a href="javascript:void();" class="btn btn-primary radius" style="width:18%" ><i class="Hui-iconfont">&#xe646;</i> 浏览文件</a>
					  <input type="file" id="install-package" name="file" accept=".apk" class="input-file">
					</span>
				</div>
			</div>

			<div class="row cl">
				<div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
					<input id="submit" class="btn btn-primary radius" type="submit" value="&nbsp;&nbsp;提交&nbsp;&nbsp;">
				</div>
			</div>
		</form>
		
	</article>

<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="static/h-ui/js/H-ui.min.js"></script> 
<script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.js"></script>

<script type="text/javascript" src="lib/My97DatePicker/4.8/WdatePicker.js"></script>


<script type="text/javascript" src="static/js/index.js"></script>



<script type="text/javascript">
	var editInfo = JSON.parse(sessionStorage.getItem('editApkInfo'))

	var errorFunc = function(xhr, status){
		layer.msg(status)
	}

	$(function(){
		
		if(editInfo){
			$('#app-name').val(editInfo.appName)
			$('#version-name').val(editInfo.versionName)
			$('#version-code').val(editInfo.versionCode)
			$('#update-instructions').val(editInfo.updateInstructions)
			$('.radio').eq(1-editInfo.mandatoryUpdate).attr('checked', true)
			$('#file-name').val(editInfo.downloadUrl)
			$('#file-red-start').hide()
		}

		$('.skin-minimal .radio').iCheck({
			// radioClass: 'iradio-green',
			increaseArea: '20%',
		})
	})

	$('#submit').click(function(event){
		event.preventDefault()
		var apkInfo = {
		    appName: $('#app-name').val(),
		    versionName: $('#version-name').val(),
		    versionCode: $('#version-code').val(),
		    updateInstructions: $('#update-instructions').val(),
		   	mandatoryUpdate: $('.radio:checked').val(),
		   	file: $('#install-package').get(0).files[0]
		}   	
	   	console.log('是否强制升级: '+apkInfo.mandatoryUpdate)
	   	console.log('安装包： '+ apkInfo.file)

		if(apkInfo.appName === ''){
			layer.msg('请输入应用名')
		}else if(apkInfo.versionName === ''){
			layer.msg('请输入VersionName')
		}else if(apkInfo.versionCode === ''){
			layer.msg('请输入VersionCode')
		}else if(!/^\d+(\.\d+)*$/.test(apkInfo.versionCode)){
			if(/\.$/.test(apkInfo.versionCode)){
				layer.msg('VersionCode小数点不能放在最后')
			}else{
				layer.msg('VersionCode只能包含数字和小数点')
			}
		}else if(apkInfo.updateInstructions === ''){
			layer.msg('请输入更新说明')
		}else if(apkInfo.file == undefined && !editInfo){
			layer.msg('请选择安装包文件')
		}
		else{
			var destination = '添加'
			var url = 'admin/package/postInstallPackage'

			if(editInfo){
				var destination = '修改'
				apkInfo.id = editInfo.id
			}
			
			var formData = new FormData()
			for(var key in apkInfo){
				formData.append(key, apkInfo[key])
			}
			
			ajax({
				url: url,
				method: 'post',
				timeout: 10*60*1000,
				data: formData,
				cache: false,
				processData: false,
			    contentType: false,
				successFunc: function(response){
					var status = response.code
					if(status === 1){
						layer.msg(destination + '成功')
						setTimeout(function(){
							parent.location.reload()
						}, 1000)
					}else if(status === 0){
							layer.open({
								type: 0,
								closeBtn: 0,
								icon:7, 
								title: destination + '失败',
								content: response.error
							})

						}
				},
				errorFunc: function(xhr, status){
					layer.open({
						type: 0,
						closeBtn: 0,
						icon:7, 
						title: '新增失败',
						content: status
					})
				}
			})
		}
	})
</script> 
</body>
</html>