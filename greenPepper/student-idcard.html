<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<title>学生证信息</title>
	<link rel="stylesheet" href="css/dialog.css">
	<style>
		*{
			padding:0;margin:0;
			box-sizing: border-box;
			font-family: 'Heiti SC';
			font-size: 16px;
			-webkit-tap-highlight-color: rgb(255, 255, 255);
		}
		body,html{
			height:100%;
		}
		.container{
			text-align: center;
			height:100%;
		}
		.title{
			margin:37px auto 20px;
			color:rgb(255, 168, 11);
		}
		.upload-container{
			height:400px;
		}
		#upload-1{
			position: relative;
			height:190px;
			border-radius: 8px;
			text-align: center;
		}
		#image-example-1{
			width:82%;
			height:100%;
			border-radius: 8px;
		}
		input[type="file"]#image-upload-1{
			position: absolute;
			width:100%;height:100%;
			top:0;left:0;
			z-index:100;
			opacity: 0;
		}
		#upload-btn{
			position: absolute;
			top:77%;left:28%;
			width:44%;
			height:15%;
			line-height: 15%;
			z-index:99;
			color:rgb(255, 255, 255);
			background-color: rgb(255, 173, 26);
			border:none;
			border-radius: 41px;
		}
		#upload-2{
			display: none;
			position:relative;
			width: 82%;
			height:190px;
			margin:20px 33px;
			border-radius:8px;
		}
		#upload-2 img#image-example-2{
			position: absolute;
			top:0;left:0;
			width:100%;height:100%;
			border-radius: 8px;
			z-index:-1;
			margin: 0;
		}
		#upload-2 img{
			width:18%;
			height:23%;
			margin:13% 41% 0px;
		}

		#upload-2 .info-text{
			margin:0 auto;
			width:176px;
			text-align: center;
			color:rgb(255, 168, 11);
		}
		#upload-2 #image-upload-2{
			position:absolute;
			top:0;left:0;
			width:100%;height:100%;
			opacity: 0;
			z-index:100;
		}

		#submit{
			width:120px;
			height:50px;
			margin:30px auto 0;
			color:rgb(255, 255, 255);
			border:none;
			font-size:18px;
			text-align: center;
			border-radius: 25px;
			background-color:rgb(244, 200, 113);

		}
	</style>
</head>
<body>
	<div class="container">
		<p class="title">手持学生证照片及个人信息页</p>
		<div class="upload-container">	
			<div class="upload" id="upload-1">
				<img id="image-example-1" src="img/imgExample.png" alt="">
				<button id="upload-btn">点击上传照片</button>
				<input type="file" id="image-upload-1" accept="image/*">
			</div>
			<div id="upload-2">
				<img src="img/imgAddBg.png" id="image-example-2" alt="">
				<div class="info" id="info-container">
					<img id="info-image" src="img/icBtnPhotograph.png" alt="">
					<p class="info-text">照片和信息不在同一页？可点击此处继续添加
					</p>
				</div>
				<input type="file" accept="image/*" id="image-upload-2">
			</div>
		</div>	
		<button id="submit">提交</button>

	</div>
	<script src="js/zepto.min.js"></script>
	<script src="js/dialog.min.js"></script>
	<script src="js/ajax.js"></script>
	<script src="js/cookie.js"></script>
	<script src="js/index.js"></script>
	<script>

		var data = JSON.parse(sessionStorage.getItem('data'))
		data.phone = sessionStorage.getItem('phone')

	
		function getObjectURL(file){
			var url = null;
		    if (window.createObjectURL != undefined) { // basic
		        url = window.createObjectURL(file);
		    } else if (window.URL != undefined) { // mozilla(firefox)
		        url = window.URL.createObjectURL(file);
		    } else if (window.webkitURL != undefined) { // webkit or chrome
		        url = window.webkitURL.createObjectURL(file);
		    }
		    return url;	
		}

		function  beforeSendFunc(xhr){

	    	popup = $(document).dialog({
						type: 'toast',
						infoIcon: 'img/loading.gif',
						infoText: '上传中 0%',
					})
	    	console.log('xhr',xhr)
	    	xhr.upload.addEventListener('progress',function(e){
	    		var percent = Math.floor(e.loaded/e.total*100);
				if(percent % 5 < 3){
					popup.update({
						infoIcon: 'img/loading.gif',
						infoText: '上传中'+percent+'%'
					})
				}	    		
	    		if(percent >= 100){
	    			popup.close()
	    		}

	    		console.log('上传中',percent)
	    	})
	    
		}
		var successFunc1 = function (response){
						
						if(response.code === 1){
							$(document).dialog({
								type: 'toast',
								infoIcon: 'img/success.png',
								infoText: '上传成功',
								autoClose: 1500
							})
							data.stuCardUrl = response.data

							$('#upload-2').show()
							$('#submit').css('background-color','rgb(242, 170, 25)')
							$('#submit').click(function(e){
								e.preventDefault()
								ajax({
									url: 'h5/authStudent',
									type: 'post',
									data: data,
									success: function(response){
										if(response.code === 1){
											window.open('submit-success.html', '_self')
										}else if(response.code === 0){
											$(document).dialog({
												type: 'toast',
												infoIcon: 'img/fail.png',
												infoText: response.error,
												autoClose: 1500
											})				
										}else{
											toast('出现错误', 'fail')
										}
									},
									error: function(xhr, status) {
										toast(status, 'fail')
									}
								})
							})
						}else if(response.code === 0){
							$(document).dialog({
									type: 'toast',
									infoIcon: 'img/fail.png',
									infoText: response.error,
									autoClose: 1500
								})
						}else{
							toast('出现错误', 'fail')
						}
					}
		var successFunc2 = function(response){
						if(response.code === 1){
							$(document).dialog({
								type: 'toast',
								infoIcon: 'img/success.png',
								infoText: '上传成功',
								autoClose: 1500
							})
							data.identityUrl = response.data 
						}else if(response.code === 0){
							toast(response.error, 'fail')
						}else{
							toast('出现错误', 'fail')
						} 
					}
		var  errorFunc = function(xhr, status){
					popup.close()
					dialog({
						text: '上传失败,请重新上传',
						type: 'confirm'
					})
		}

		function upload(url, formData, success, error){
			ajax({
					url: url,
					type: 'post',
					timeout: 20*1000,
					data: formData,
					cache: false,
					processData: false,
				    contentType: false,
				    beforeSend: beforeSendFunc,
				    success: success,
				    error: error,
			})
		}

		$('#image-upload-1').change(function(){
			var fileInput = $('#image-upload-1')[0];
			file = fileInput.files[0]
			console.log('file',file)
			var imgUrl = getObjectURL(file)
			console.log('url', imgUrl)
			$('#image-example-1').attr('src', imgUrl)
			$('#upload-btn').hide()

			// reader.readAsDataURL(file)
			
			var form = new FormData()
			form.append('file',file)

			upload('upload/studentImage', form, successFunc1, errorFunc)
			
		})		

		$('#image-upload-2').change(function(){
			var fileInput = $('#image-upload-2')[0];
			file = fileInput.files[0]
			console.log(file)
			var imgUrl = getObjectURL(file)
			console.log('url', imgUrl)
			$('#image-example-2').attr('src', imgUrl)	
			$('#info-container').hide()
			var form = new FormData()
			form.append('file',file)

			upload('upload/studentImage', form, successFunc2, errorFunc)
		})
		

	</script>
</body>
</html>