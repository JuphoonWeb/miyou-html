<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<title>手机验证</title>
	<link rel="stylesheet" href="css/dialog.css">
	<style>
		*{
			padding:0;margin:0;
			box-sizing: border-box;
			font-family: 'Heiti SC';
			font-size: 16px;
			-webkit-tap-highlight-color: transparent;
		}
		
		.notice-info{
			padding:35px;
		}
		.auth-code{
			text-align: center;
			height:70px;
			margin: 0 auto;
		}
		.auth-code input{
			display: inline-block;
			width:45px;
			height:45px;
			padding-left: 15px;
			font-size:25px;
			outline:none;
			border:1px solid rgb(185, 185, 185);
			border-radius: 5px;
			
		}
		.auth-code input+input{
			margin-left: 10px;
		}
		.auth-code input:focus,.auth-code input.hasValue{
			color:rgb(249, 173, 68);
			border:1px solid rgb(249, 173, 68);
		}
		.error{
			text-align: center;
			color:rgb(209, 0, 0);
			font-size:12px;
			margin-top: 10px;
			display: none;
		}
		.btn{
			position: relative;
			display: block;
			width: 300px;
			height: 50px;
			margin: 20px auto;
			border: none;
			color:rgb(255, 255, 255);
			background-color: rgb(242, 170, 25);
			font-size: 20px;
			border-radius:30px;
			box-shadow: 0 2px 5px 0 rgba(231, 119, 22, 0.44);
		}
		#spinner{
			position: absolute;
			top:10px;left:90px;
			width:30px;
			height:30px;
			color:white;
			margin-right:5px;
			display: none;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="notice-info">
			<p>为确保当前操作是由本人发起，
		青椒校园已向你注册的手机发送短信，
		请输入短信中的验证码完成手机验证</p>
		</div>
	</div>
	<div class="auth-code">
		<input type="number" id="code-1" maxlength="1">
		<input type="number" id="code-2" maxlength="1">
		<input type="number" id="code-3" maxlength="1">
		<input type="number" id="code-4" maxlength="1">
		<div class="error">验证码错误，请重新获取并输入</div>
	</div>
	<button class="btn send-btn"><img id="spinner"  src="img/auth-phone-loading.gif" alt="" /><p class="text-in-btn">发送验证码</p></button>
</body>
<script src="js/zepto.min.js"></script>
<script src="js/ajax.js"></script>
<script src="js/dialog.min.js"></script>
<script src="js/index.js"></script>
<script>
	
	$(document).ready(function(){
		$('input[type=number]').val('').removeClass('hasValue')
		sendCode()
	})

	$(document).on('input','input',function(){
		$('.error').hide()
		var value = $(this).val()
		if(value){
			$(this).addClass('hasValue')
			$(this).next().focus()
			
			if(value.length > 1){
				
				for(var i = 0;i < value.length; i++){
					var sequence = parseInt($(this).attr('id').split('-')[1])+i	
					$('#code-'+sequence)
						.val(value[i])
						.addClass('hasValue')
						.next().focus()	
				}
			}
		}else{
			$(this).removeClass('hasValue')
			$(this).prev().focus()
		}

		var code = $('#code-1').val()+$('#code-2').val()+$('#code-3').val()+$('#code-4').val()

		if(code.length == 4){
			$('input[type=number]').blur()
			validate(code)
		}		
	})
	

	function sendCode(){
		$('.error').hide()
		$('input[type=number]').val('').removeClass('hasValue')
		ajax({
			url: 'h5/sendCode',
			type: 'post',
			data: {
				phone: sessionStorage.getItem('phone')
			},
			success: function(response){
				if(response.code != 1){
				
					notice('出现错误')
				}
			},
			error: function(xhr, status){
				notice(status)
			}
		})
	
		$('.send-btn').css('background-color','rgba(231, 119, 22, 0.44)')
					  .attr('disabled', true)
		var second = 60
		$('.text-in-btn')
			.text(second+'s后可重发')
			.addClass('countdown-text')
		var that = $('.send-btn')
		var intervalId = setInterval(function(){
			second--
			$('.countdown-text').text(second+'s后可重发')
			if(second == 0 || $('.countdown-text').length == 0){
				clearInterval(intervalId)
				that.css('background-color', 'rgb(242, 170, 25)')
					.removeAttr('disabled')
				if(second == 0){
					$('.text-in-btn').text('发送验证码')
				}
			}
		},1000)
	}

	function validate(code){
			$('#spinner').attr('src','img/auth-phone-loading.gif').show()
			$('.text-in-btn').removeClass('countdown-text').text('验证中')
			$('.send-btn').attr('disabled',true).css('background-color', 'rgb(242, 170, 25)')
			ajax({
				url: 'h5/validateCode',
				type: 'post',
				data: {
					phone: sessionStorage.getItem('phone'),
					code: code,
				},
				success: function(response){
					if(response.code === 1){
						$('input[type=number]').attr('readonly',true)
						$('#spinner').attr('src', 'img/auth-phone-ok.svg').css('width','20px').show()
						$('.text-in-btn').text('验证成功')
						$('.send-btn')
							.removeAttr('disabled')
							.off()
							.click(function(){
								window.open('basic-info-new.html','_self')
							})	
					}else{
						// notice('验证失败，请重新验证')
						$('.error').show()
						$('input[type=number]').blur() 
						$('#spinner').hide()
						$('.text-in-btn')
							.text('发送验证码')
						$('.send-btn')
							.removeAttr('disabled')
							.click(function(){
								sendCode()
							})
					}
				},
				error: function(xhr, status){
					notice(status)
				}
			})
	}

</script>
</html>